<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>TJPE ¬∑ NOMEA√á√ÉO DATIVO</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',sans-serif;background:#0A0E1A;color:#E8F0FF;height:100vh;overflow:hidden;display:flex;flex-direction:column;}
#login-screen{position:fixed;inset:0;background:#0A0E1A;display:flex;align-items:center;justify-content:center;z-index:9999;}
.login-box{background:#0F1628;border:1px solid #1E2D4A;border-radius:18px;padding:36px 28px;width:90%;max-width:360px;text-align:center;}
.login-icon{font-size:2.5rem;margin-bottom:12px;}
.login-title{font-size:.85rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:#E8F0FF;margin-bottom:4px;}
.login-sub{font-size:.65rem;color:#4A6080;text-transform:uppercase;letter-spacing:.3px;margin-bottom:24px;}
.login-box input{margin-bottom:12px;text-align:center;letter-spacing:2px;font-size:1rem;}
.login-btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#4F8EF7,#3B6FD4);color:#fff;font-size:.8rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;}
.login-err{font-size:.7rem;color:#EF4444;margin-top:10px;display:none;text-transform:uppercase;font-weight:700;}
body.light{background:#F0F4FF;color:#0F1F40;}
body.light .app{background:#F0F4FF;}
body.light .topbar{background:#FFFFFF;border-color:#D0D9F0;}
body.light .nav{background:#FFFFFF;border-color:#D0D9F0;}
body.light .nb{color:#8A9EC0;}
body.light .nb.on{color:#1D5FCF;}
body.light .card{background:#FFFFFF;border-color:#D0D9F0;}
body.light .ch{border-color:#D0D9F0;}
body.light .ch h2{color:#0F1F40;}
body.light .lbl{color:#3A5080;}
body.light input,body.light textarea,body.light select{background:#FFFFFF;border-color:#C8D6EE;color:#0F1F40;}
body.light input:focus,body.light textarea:focus,body.light select:focus{border-color:#1D5FCF;}
body.light select option{background:#FFFFFF;color:#0F1F40;}
body.light .bg{background:#F5F7FF;border-color:#B8C7E8;color:#3A5080;}
body.light .pb{background:#E8EEFF;}
body.light .mpre{background:#E8EEFF;border-color:#D0D9F0;color:#3A5080;}
body.light .tab{background:#F5F7FF;border-color:#D0D9F0;color:#8A9EC0;}
body.light .tab.on{background:rgba(29,95,207,.1);border-color:rgba(29,95,207,.35);color:#1D5FCF;}
body.light .sr{background:#F5F7FF;border-color:#D0D9F0;}
body.light .snm{color:#0F1F40;}
body.light .hi{background:#F5F7FF;border-color:#D0D9F0;}
body.light .ha{color:#0F1F40;}
body.light .ci{background:#F5F7FF;border-color:#D0D9F0;}
body.light .wc{background:#E8EEFF;border-color:#D0D9F0;}
body.light .adv-box{background:rgba(29,95,207,.06);border-color:rgba(29,95,207,.2);color:#1D5FCF;}
body.light .aij-dt{background:rgba(8,145,178,.06);border-color:rgba(8,145,178,.25);color:#0891B2;}
body.light .clbl{color:#3A5080;}
body.light .sn{color:#1D5FCF;}
body.light .hd{color:#1D5FCF;}
body.light .tinfo-title{color:#0F1F40;}
body.light .tinfo-vara{color:#0F1F40;}
.app{display:flex;flex-direction:column;height:100vh;max-width:480px;margin:0 auto;background:#0A0E1A;box-shadow:0 0 40px rgba(0,0,0,.5);}
@media(min-width:768px){
  body{overflow:auto;height:auto;}
  .app{max-width:860px;height:auto;min-height:100vh;}
  .pages{flex:1;position:relative;overflow:visible;height:auto;}
  .page{position:relative;inset:auto;overflow:visible;display:none;padding:24px 32px;width:100%;}
  .page.active{display:block;}
  .nav{position:sticky;bottom:0;z-index:100;}
  .mpre{max-height:600px;}
  .g2{grid-template-columns:1fr 1fr 1fr;}
}
.topbar{background:#0F1628;border-bottom:1px solid #1E2D4A;padding:10px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.ticons{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.ticon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#4F8EF7,#7C3AED);display:flex;align-items:center;justify-content:center;font-size:18px;}
.ticon-claude{width:30px;height:30px;border-radius:8px;background:#CC785C;display:flex;align-items:center;justify-content:center;}
.tinfo{flex:1;min-width:0;text-align:center;}
.tinfo-title{font-size:.72rem;font-weight:800;color:#E8F0FF;text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px;}
.tinfo-vara{font-size:.58rem;font-weight:700;color:#E8F0FF;text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px;}
.tinfo-dev{font-size:.56rem;font-weight:800;color:#2563EB;text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px;}
.tinfo-email{font-size:.55rem;color:#60A5FA;display:flex;align-items:center;justify-content:center;gap:4px;}
.tbtn{display:flex;align-items:center;justify-content:center;gap:4px;padding:5px 10px;border-radius:8px;border:none;font-size:.6rem;font-weight:800;cursor:pointer;letter-spacing:.4px;text-transform:uppercase;white-space:nowrap;color:#fff;width:80px;}
.tbtn-pje{background:linear-gradient(135deg,#1D4ED8,#2563EB);}
.pages{flex:1;position:relative;overflow:hidden;}
.page{position:absolute;inset:0;overflow-y:auto;padding:14px;display:none;}
.page.active{display:block;}
.nav{background:#0F1628;border-top:1px solid #1E2D4A;display:flex;flex-shrink:0;}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 2px;gap:2px;font-size:.5rem;font-weight:800;color:#4A6080;text-transform:uppercase;border:none;background:none;cursor:pointer;letter-spacing:.3px;}
.nb.on{color:#4F8EF7;}
.ni{font-size:18px;line-height:1;}
.card{background:rgba(255,255,255,.03);border:1px solid #1E2D4A;border-radius:14px;margin-bottom:12px;overflow:hidden;}
.ch{padding:11px 14px;border-bottom:1px solid #1E2D4A;display:flex;align-items:center;gap:8px;}
.ch h2{font-size:.76rem;font-weight:800;text-transform:uppercase;letter-spacing:.4px;color:#E8F0FF;}
.cb{padding:14px;}
.fg{margin-bottom:14px;}
.lbl{display:block;font-size:.64rem;font-weight:800;color:#4A6080;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;}
input,textarea,select{display:block;width:100%;padding:9px 12px;border-radius:9px;background:#141D35;border:1px solid #263552;color:#E8F0FF;font-size:.87rem;font-family:'Segoe UI',sans-serif;outline:none;-webkit-appearance:none;appearance:none;transition:border-color .2s;}
input:focus,textarea:focus,select:focus{border-color:#4F8EF7;}
textarea{resize:vertical;min-height:80px;line-height:1.5;}
select option{background:#141D35;color:#E8F0FF;}
.btn{padding:9px 16px;border-radius:10px;font-size:.78rem;font-weight:800;cursor:pointer;border:1px solid;display:inline-flex;align-items:center;gap:6px;font-family:inherit;text-transform:uppercase;letter-spacing:.4px;transition:opacity .2s;}
.btn:active{opacity:.8;}
.bg{background:#141D35;border-color:#263552;color:#8BA3CC;}
.bp{background:linear-gradient(135deg,#4F8EF7,#3B6FD4);border-color:transparent;color:#fff;width:100%;justify-content:center;padding:12px;}
.bp:disabled{background:#1A2540;border-color:#1E2D4A;color:#4A6080;cursor:not-allowed;}
.bd{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);color:#EF4444;}
.pb{height:4px;background:#1A2540;border-radius:999px;overflow:hidden;margin-top:6px;}
.pf{height:100%;border-radius:999px;background:linear-gradient(90deg,#4F8EF7,#7C3AED);transition:width .3s;}
.adv-box{padding:8px 12px;border-radius:9px;background:rgba(79,142,247,.07);border:1px solid rgba(79,142,247,.2);font-size:.72rem;color:#4F8EF7;font-weight:800;margin-bottom:12px;text-transform:uppercase;}
.divider{height:1px;background:#1E2D4A;margin:14px 0;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.aij-dt{padding:8px 12px;border-radius:8px;background:rgba(6,182,212,.08);border:1px solid rgba(6,182,212,.25);font-size:.72rem;color:#06B6D4;font-weight:800;margin-bottom:12px;}
.mpre{background:#0F1628;border:1px solid #1E2D4A;border-radius:10px;padding:14px;white-space:pre-wrap;font-family:'Courier New',monospace;font-size:.73rem;line-height:1.7;color:#8BA3CC;max-height:320px;overflow-y:auto;}
.tabs{display:flex;gap:4px;margin-bottom:10px;}
.tab{padding:6px 14px;border-radius:8px;font-size:.7rem;font-weight:800;cursor:pointer;border:1px solid #1E2D4A;background:#141D35;color:#4A6080;text-transform:uppercase;}
.tab.on{background:rgba(79,142,247,.15);border-color:rgba(79,142,247,.4);color:#4F8EF7;}
.sr{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;background:#141D35;border:1px solid #1E2D4A;margin-bottom:6px;}
.sn{font-size:1.3rem;font-weight:800;color:#4F8EF7;}
.snm{font-size:.68rem;font-weight:700;color:#E8F0FF;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-transform:uppercase;}
.ss{font-size:.6rem;color:#4A6080;}
.hi{padding:10px 12px;border-radius:10px;background:#141D35;border:1px solid #1E2D4A;border-left:3px solid #4F8EF7;margin-bottom:6px;}
.hd{font-size:.68rem;font-weight:800;color:#4F8EF7;text-transform:uppercase;}
.ha{font-size:.72rem;font-weight:700;color:#E8F0FF;text-transform:uppercase;margin-top:2px;}
.hs{font-size:.65rem;color:#4A6080;text-transform:uppercase;margin-top:1px;}
.ci{padding:12px;border-radius:10px;background:#141D35;border:1px solid #1E2D4A;border-left:3px solid #06B6D4;margin-bottom:8px;}
.cd{font-size:.75rem;font-weight:800;color:#06B6D4;text-transform:uppercase;}
.cs{font-size:.68rem;color:#8BA3CC;margin-top:3px;text-transform:uppercase;}
.empty{text-align:center;padding:20px;color:#4A6080;font-size:.78rem;text-transform:uppercase;}
.wc{padding:10px;border-radius:9px;background:#1A2540;border:1px solid #1E2D4A;margin-bottom:8px;}
.wc input{margin-bottom:6px;}
.toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);max-width:340px;width:90%;padding:12px 16px;border-radius:12px;font-size:.76rem;font-weight:700;z-index:9999;border:1px solid;text-align:center;text-transform:uppercase;display:none;pointer-events:none;}
.ts{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.3);color:#6EE7B7;}
.te{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.3);color:#FCA5A5;}
.ti{background:rgba(79,142,247,.15);border-color:rgba(79,142,247,.3);color:#93C5FD;}
.clbl{font-size:.63rem;font-weight:800;color:#4A6080;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;}
#cal-status{font-size:.65rem;font-weight:800;text-transform:uppercase;padding:5px 10px;border-radius:7px;display:none;margin-bottom:8px;}
#cal-status.ok{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);color:#6EE7B7;}
#cal-status.err{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#FCA5A5;}
</style>
</head>
<body>

<div id="login-screen">
  <div class="login-box">
    <div class="login-icon">‚öñÔ∏è</div>
    <div class="login-title">TJPE ¬∑ PautaJuri</div>
    <div class="login-sub">Vara Regional do J√∫ri ¬∑ Acesso Restrito</div>
    <input id="login-input" type="password" placeholder="Digite a senha" onkeydown="if(event.key==='Enter')fazerLogin()">
    <button class="login-btn" onclick="fazerLogin()">üîê ENTRAR</button>
    <div id="login-err" class="login-err">‚ùå Senha incorreta. Tente novamente.</div>
  </div>
</div>

<div class="app" id="main-app" style="display:none;">
  <header class="topbar" style="flex-direction:column;padding:10px 14px 8px;gap:8px;">
    <div style="display:flex;align-items:center;gap:10px;width:100%;">
      <div class="ticons">
        <div class="ticon">‚öñÔ∏è</div>
        <div class="ticon-claude">
          <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 40 40" fill="none">
            <path d="M20 4 L23.5 16.5 L36 20 L23.5 23.5 L20 36 L16.5 23.5 L4 20 L16.5 16.5 Z" fill="#fff" opacity=".95"/>
          </svg>
        </div>
      </div>
      <div class="tinfo" style="flex:1;">
        <div class="tinfo-title">Sistema de Nomea√ß√£o de Advogado(a) Dativo/Audi√™ncia</div>
        <div class="tinfo-vara">VARA REGIONAL DO J√öRI ¬∑ CSA E IPOJUCA</div>
        <div class="tinfo-dev">Desenvolvedor: Geison Merc√™s / Claude</div>
        <div class="tinfo-email">
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#60A5FA" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
          <span>geison.merces@tjpe.jus.br</span>
        </div>
      </div>
      <div id="themeBtn" onclick="toggleTheme()" style="width:34px;height:20px;border-radius:999px;background:#4F8EF7;position:relative;cursor:pointer;transition:background .3s;flex-shrink:0;">
        <div id="thumbBtn" style="width:14px;height:14px;border-radius:50%;background:#fff;position:absolute;top:3px;left:17px;transition:left .3s;box-shadow:0 1px 4px rgba(0,0,0,.3);"></div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:6px;width:100%;">
      <button class="tbtn tbtn-pje" style="flex:1;" onclick="abrirPje()">
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>PJE
      </button>
      <button class="tbtn tbtn-pje" style="flex:1;" onclick="abrirCalendario()">
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>CALEND√ÅRIO
      </button>
      <button class="tbtn tbtn-pje" style="flex:1;" onclick="copiar()">
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>COPIAR
      </button>
<button class="tbtn tbtn-pje" onclick="limparFormulario()">
  <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="3 6 5 6 21 6"/>
    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
    <path d="M10 11v6"/>
    <path d="M14 11v6"/>
    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
  </svg>
  LIMPAR
</button>

      <button id="btnObsStatus" onclick="testarObs()"
        style="flex:1;display:flex;align-items:center;justify-content:center;gap:4px;padding:5px 8px;border-radius:8px;border:1px solid #263552;background:#141D35;color:#F59E0B;font-size:.58rem;font-weight:800;cursor:pointer;letter-spacing:.3px;text-transform:uppercase;white-space:nowrap;">
        <div id="dot" style="width:7px;height:7px;border-radius:50%;background:#F59E0B;flex-shrink:0;"></div>
        <span id="obsLabel">OFFLINE</span>
      </button>
    </div>
  </header>

  <div class="pages">
    <div id="pg-form" class="page active">
      <div class="card" style="padding:12px 14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span class="lbl" style="margin:0;">PROGRESSO</span>
          <span id="pct" style="font-size:.65rem;font-weight:800;color:#4F8EF7;">0%</span>
        </div>
        <div class="pb"><div id="pf" class="pf" style="width:0%"></div></div>
      </div>
      <div class="card">
        <div class="ch"><span>üìã</span><h2>DADOS DA NOMEA√á√ÉO</h2></div>
        <div class="cb">
          <div class="fg"><label class="lbl" for="f1">1. NPU ‚Äî N√öMERO DO PROCESSO *</label><input id="f1" type="text" placeholder="0000000-00.0000.8.17.0000"></div>
          <div class="fg"><label class="lbl" for="f2">2. NOME COMPLETO DO(S) ACUSADO(S) *</label><input id="f2" type="text" placeholder="NOME COMPLETO DO(S) ACUSADO(S)"></div>
          <div class="fg">
            <label class="lbl" for="f3">3. ADVOGADO(A) DATIVO(A) *</label>
            <select id="f3">
              <option value="">‚Äî SELECIONE ‚Äî</option>
              <option value="elivalte" data-nome="DR. ELIVALTE FERNANDO DE SOUZA" data-oab="38027/PE">DR. ELIVALTE FERNANDO DE SOUZA ¬∑ OAB 38027/PE</option>
              <option value="jose_aniceto" data-nome="DR. JOS√â ANICETO DE SANTANA J√öNIOR" data-oab="48073/PE">DR. JOS√â ANICETO DE SANTANA J√öNIOR ¬∑ OAB 48073/PE</option>
              <option value="paula_cristiane" data-nome="DRA. PAULA CRISTIANE TORRES MAGALH√ÉES" data-oab="24982/PE">DRA. PAULA CRISTIANE TORRES MAGALH√ÉES ¬∑ OAB 24982/PE</option>
              <option value="caiky_cezary" data-nome="DR. CAIKY CEZARY COSTA COUTINHO" data-oab="35960/PE">DR. CAIKY CEZARY COSTA COUTINHO ¬∑ OAB 35960/PE</option>
              <option value="patricia_maria" data-nome="DRA. PATR√çCIA MARIA DE LIMA" data-oab="45952/PE">DRA. PATR√çCIA MARIA DE LIMA ¬∑ OAB 45952/PE</option>
              <option value="douglas_felipe" data-nome="DR. DOUGLAS FELIPE DA SILVA BALBINO" data-oab="54235/PE">DR. DOUGLAS FELIPE DA SILVA BALBINO ¬∑ OAB 54235/PE</option>
              <option value="aurelio_rafael" data-nome="DR. AUR√âLIO RAFAEL MARTINS FELIX DE SOUZA" data-oab="33996/PE">DR. AUR√âLIO RAFAEL MARTINS FELIX DE SOUZA ¬∑ OAB 33996/PE</option>
              <option value="julio_cesar" data-nome="DR. J√öLIO CESAR PEREIRA CORREIA" data-oab="50732/PE">DR. J√öLIO CESAR PEREIRA CORREIA ¬∑ OAB 50732/PE</option>
              <option value="rodrigo_alves" data-nome="DR. RODRIGO ALVES BRITO OLIVEIRA" data-oab="58833/PE">DR. RODRIGO ALVES BRITO OLIVEIRA ¬∑ OAB 58833/PE</option>
              <option value="emerson_rodrigues" data-nome="DR. √âMERSON RODRIGUES DE SOUZA" data-oab="56655/PE">DR. √âMERSON RODRIGUES DE SOUZA ¬∑ OAB 56655/PE</option>
              <option value="fabiana_andresa" data-nome="DRA. FABIANA ANDRESA DE LIMA GOMES" data-oab="28259/PE">DRA. FABIANA ANDRESA DE LIMA GOMES ¬∑ OAB 28259/PE</option>
              <option value="marianna_athayde" data-nome="DRA. MARIANNA DE ATHAYDE LIMA" data-oab="43178/PE">DRA. MARIANNA DE ATHAYDE LIMA ¬∑ OAB 43178/PE</option>
              <option value="mariana_santos" data-nome="DRA. MARIANA SANTOS DE OLIVEIRA" data-oab="383787/SP">DRA. MARIANA SANTOS DE OLIVEIRA ¬∑ OAB 383787/SP</option>
              <option value="joao_ismar" data-nome="DR. JO√ÉO ISMAR FERREIRA DA SILVA" data-oab="VERIFICAR/PE">DR. JO√ÉO ISMAR FERREIRA DA SILVA ¬∑ OAB VERIFICAR/PE</option>
            </select>
          </div>
          <div id="advbox" class="adv-box" style="display:none;"></div>
          <div class="fg">
            <label class="lbl" for="f4">4. CONTEXTO DA NOMEA√á√ÉO * <span style="color:#06B6D4;font-size:.6rem;">(2¬∫ PAR√ÅGRAFO DO I ‚Äî RELAT√ìRIO)</span></label>
            <textarea id="f4" rows="4" placeholder="EX: A DEFENSORIA P√öBLICA DEIXOU TRANSCORRER O PRAZO PARA ALEGA√á√ïES FINAIS..."></textarea>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="ch"><span>üìù</span><h2>OBSERVA√á√ïES ADICIONAIS</h2></div>
        <div class="cb">
          <div class="fg">
            <label class="lbl" for="flocobs">INSERIR EM:</label>
            <select id="flocobs">
              <option value="nenhum">N√ÉO INCLUIR</option>
              <option value="apos_nomeio">III ‚Äî DISPOSITIVO (ap√≥s nomea√ß√£o)</option>
              <option value="relatorio">I ‚Äî RELAT√ìRIO</option>
              <option value="fundamentacao">II ‚Äî FUNDAMENTA√á√ÉO</option>
            </select>
          </div>
          <div class="fg"><label class="lbl" for="fobs">TEXTO:</label><textarea id="fobs" rows="2" placeholder="TEXTO DAS OBSERVA√á√ïES ADICIONAIS" disabled style="opacity:.4"></textarea></div>
        </div>
      </div>
      <div class="card">
        <div class="ch"><span>üóì</span><h2>AUDI√äNCIA DE INSTRU√á√ÉO E JULGAMENTO</h2></div>
        <div class="cb">
          <div class="fg">
            <label class="lbl" for="faij">5. ESTE PROCESSO TER√Å AIJ? *</label>
            <select id="faij">
              <option value="NAO">N√ÉO ‚Äî NOMEA√á√ÉO SIMPLES (MODELO 01)</option>
              <option value="SIM">SIM ‚Äî COM AIJ (MODELO 02)</option>
            </select>
          </div>
          <div id="aij-bloco" style="display:none;">
            <div class="g2" style="margin-bottom:12px;">
              <div><label class="lbl" for="fdata">6. DATA DA AIJ *</label><input id="fdata" type="text" inputmode="numeric" maxlength="10" placeholder="EX: 15/04/2026" oninput="this.value=maskData(this);S.dataij=this.value;updateAijDt();calcProg();" onblur="this.value=maskData(this);S.dataij=this.value;updateAijDt();calcProg();"></div>
              <div><label class="lbl" for="fhoraIni">7. HOR√ÅRIO (IN√çCIO)</label><input id="fhoraIni" type="text" inputmode="numeric" maxlength="5" placeholder="EX: 14:00" oninput="this.value=maskHora(this);S.horaIni=this.value;updateAijDt();" onblur="this.value=maskHora(this);S.horaIni=this.value;updateAijDt();"></div>
            </div>
            <div class="g2" style="margin-bottom:12px;">
              <div><label class="lbl" for="fhoraFim">8. HOR√ÅRIO (T√âRMINO)</label><input id="fhoraFim" type="text" inputmode="numeric" maxlength="5" placeholder="EX: 16:00" oninput="this.value=maskHora(this);S.horaFim=this.value;updateAijDt();" onblur="this.value=maskHora(this);S.horaFim=this.value;updateAijDt();"></div>
              <div><label class="lbl" for="fpreso">R√âU PRESO?</label>
                <label class="inp" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                  <input id="fpreso" type="checkbox" style="width:22px;height:22px;accent-color:#ef4444;cursor:pointer;" onchange="S.reuPreso=this.checked;updateAijDt();">
                  <span style="font-weight:900;">SIM</span>
                </label>
              </div>
            </div>
            <div id="aij-dt" class="aij-dt" style="display:none;"></div>
            <div class="fg"><label class="lbl" for="flink">9. LINK DE AUDI√äNCIA (OPCIONAL)</label><input id="flink" type="text" placeholder="HTTPS://..."></div>
            <div class="divider"></div>
            <div class="lbl" style="margin-bottom:8px;">üë• TESTEMUNHAS ‚Äî ACUSA√á√ÉO</div>
            <div id="wac"></div>
            <button class="btn bg" style="font-size:.7rem;padding:5px 12px;margin-bottom:14px;" onclick="addW('ac')">+ ADICIONAR TESTEMUNHA</button>
            <div class="lbl" style="margin-bottom:8px;">üë• TESTEMUNHAS ‚Äî DEFESA</div>
            <div id="wdf"></div>
            <button class="btn bg" style="font-size:.7rem;padding:5px 12px;" onclick="addW('df')">+ ADICIONAR TESTEMUNHA</button>
</div>
      <div style="margin-bottom:80px;">
        <button id="btnGerar" class="btn bp" onclick="gerarMinuta()" disabled>‚ö° GERAR MINUTA</button>
      </div>
    </div>

    <div id="pg-minuta" class="page">
      <div class="card">
        <div class="ch"><span>üìÑ</span><h2>MINUTA GERADA</h2></div>
        <div class="cb">
          <div id="m-empty" class="empty">NENHUMA MINUTA GERADA.<br>PREENCHA O FORMUL√ÅRIO E CLIQUE EM GERAR.</div>
          <div id="m-content" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
              <div class="tabs">
                <div id="tw" class="tab on" onclick="setTab('w')">WORD / PJE</div>
                <div id="tm" class="tab" onclick="setTab('m')">MARKDOWN</div>
              </div>
              <button id="btnCal" class="tbtn tbtn-pje" style="display:none;" onclick="criarEventoCalendar()">
                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>AGENDAR
              </button>
            </div>
            <div id="cal-status"></div>
            <pre id="mpre" class="mpre"></pre>
          </div>
        </div>
      </div>
    </div>

    <div id="pg-stats" class="page">
      <div class="card">
        <div class="ch"><span>üìä</span><h2>CONTROLE DE NOMEA√á√ïES</h2></div>
        <div class="cb">
          <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
            <button class="btn bd" style="padding:4px 10px;font-size:.68rem;" onclick="zerarCtrl()">ZERAR TUDO</button>
          </div>
          <div id="stats-list" style="max-height:300px;overflow-y:auto;"></div>
        </div>
      </div>
      <div id="hist-card" class="card" style="display:none;">
        <div class="ch"><span>üïì</span><h2>HIST√ìRICO RECENTE</h2></div>
        <div class="cb"><div id="hist-list" style="max-height:220px;overflow-y:auto;"></div></div>
      </div>
      <div class="card">
        <div class="ch"><span>üìÖ</span><h2>AUDI√äNCIAS AGENDADAS</h2></div>
        <div class="cb">
          <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
            <button class="btn bd" style="padding:4px 10px;font-size:.68rem;" onclick="zerarAud()">ZERAR</button>
          </div>
          <div id="aud-list" style="max-height:240px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <div id="pg-config" class="page">
      <div class="card">
        <div class="ch"><span>üîå</span><h2>CONEX√ÉO OBSIDIAN</h2></div>
        <div class="cb">
          <div class="fg"><div class="clbl">BASE URL</div><input id="cUrl" type="text" value="https://127.0.0.1:27124"></div>
          <div class="fg"><div class="clbl">TOKEN DE AUTENTICA√á√ÉO</div><input id="cTok" type="text" placeholder="COLE O TOKEN AQUI"></div>
          <button class="btn bg" style="width:100%;justify-content:center;" onclick="testarObs()">üî¥ TESTAR CONEX√ÉO</button>
        </div>
      </div>
      <div class="card">
        <div class="ch"><span>üìÑ</span><h2>CAMINHOS DOS MODELOS (OBSIDIAN)</h2></div>
        <div class="cb">
          <div class="fg"><div class="clbl">MODELO 01 ‚Äî SEM AIJ</div><input id="cM01" type="text" value="VARA REGIONAL DO J√öRI - TJPE/1 - MODELOS DE DECIS√ïES/Decis√µes/Modelo 01 - Nomea√ß√£o de Advogado Dativo - 17.02.2026.md"></div>
          <div class="fg"><div class="clbl">MODELO 02 ‚Äî COM AIJ</div><input id="cM02" type="text" value="VARA REGIONAL DO J√öRI - TJPE/1 - MODELOS DE DECIS√ïES/Decis√µes/Modelo 02 - Nomea√ß√£o de Advogado Dativo mais Instru√ß√£o e julgamento.md"></div>
          <div style="font-size:.65rem;color:#10B981;margin-top:4px;">‚úÖ SE OBSIDIAN OFFLINE, OS MODELOS EMBUTIDOS SER√ÉO UTILIZADOS AUTOMATICAMENTE.</div>
        </div>
      </div>
      <div class="card">
        <div class="ch"><span>üîê</span><h2>ALTERAR SENHA DE ACESSO</h2></div>
        <div class="cb">
          <div class="fg"><div class="clbl">NOVA SENHA</div><input id="novaSenha" type="password" placeholder="DIGITE A NOVA SENHA"></div>
          <div class="fg"><div class="clbl">CONFIRMAR NOVA SENHA</div><input id="confSenha" type="password" placeholder="CONFIRME A NOVA SENHA"></div>
          <button class="btn bg" style="width:100%;justify-content:center;" onclick="alterarSenha()">üîê SALVAR NOVA SENHA</button>
        </div>
      </div>
      <div class="card">
        <div class="ch"><span>‚ÑπÔ∏è</span><h2>INFORMA√á√ïES DO SISTEMA</h2></div>
        <div class="cb" style="font-size:.72rem;color:#8BA3CC;line-height:1.9;text-transform:uppercase;">
          <div>SISTEMA: NOMEA√á√ÉO DE ADVOGADO(A)S DATIVO(A)S</div>
          <div>TRIBUNAL: TJPE ‚Äî VARA REGIONAL DO J√öRI</div>
          <div>COMARCA: CABO DE SANTO AGOSTINHO E IPOJUCA</div>
          <div>DESENVOLVEDOR: GEISON MERC√äS / CLAUDE</div>
          <div style="margin-top:8px;color:#10B981;">‚úÖ MODELOS 01 E 02 EMBUTIDOS ‚Äî FUNCIONAM SEM OBSIDIAN.</div>
        </div>
      </div>
      <div style="margin-bottom:80px;"></div>
    </div>
  </div>

  <nav class="nav">
    <button class="nb on" id="nb-form"   onclick="goPage('form')"><span class="ni">üìã</span>FORMUL√ÅRIO</button>
    <button class="nb"    id="nb-minuta" onclick="goPage('minuta')"><span class="ni">üìÑ</span>MINUTA</button>
    <button class="nb"    id="nb-stats"  onclick="goPage('stats')"><span class="ni">üìä</span>CONTROLE</button>
    <button class="nb"    id="nb-config" onclick="goPage('config')"><span class="ni">‚öôÔ∏è</span>CONFIGURA√á√ïES</button>
  </nav>
</div>
<div id="toast" class="toast ti"></div>

<script>
// ‚îÄ‚îÄ MODELOS EMBUTIDOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var M01 = "**DECIS√ÉO**\n\n**I \u2013 RELAT√ìRIO**\n\nTrata-se de a√ß√£o penal submetida ao rito do Tribunal do J√∫ri em que figura como acusado(s) **{{ACUSADOS}}**.\n\n{{CONTEXTO}}\n\n√â o relat√≥rio.\n\n**II \u2013 FUNDAMENTA√á√ÉO JUR√çDICA**\n\nA Constitui√ß√£o Federal assegura aos acusados o contradit√≥rio, a ampla defesa e a assist√™ncia jur√≠dica integral, cabendo ao Estado garantir a efetividade da defesa t√©cnica em todas as fases do processo (art. 5¬∫, incisos LV e LXXIV, da CF).\n\nO C√≥digo de Processo Penal veda o processamento sem defensor e exige manifesta√ß√£o fundamentada da defesa (arts. 261, caput e par√°grafo √∫nico, e 263 do CPP), sendo firme a jurisprud√™ncia do STJ no sentido de que a aus√™ncia de alega√ß√µes finais defensivas, especialmente em processos do Tribunal do J√∫ri, configura nulidade absoluta quando n√£o suprida por atua√ß√£o t√©cnica.\n\nNo caso, diante da in√©rcia da Defensoria P√∫blica e da inexist√™ncia de defensor p√∫blico designado permanentemente para a unidade, imp√µe-se a nomea√ß√£o de defensor dativo para assegurar o pleno exerc√≠cio da defesa.\n\n**III - DISPOSITIVO**\n\nAssim, com fundamento na Constitui√ß√£o Federal, no C√≥digo de Processo Penal e na Lei Estadual n¬∫ 17.518/2021:\n\nNomeio o(a) **{{ADVOGADO}}**, OAB/PE n¬∫ **{{OAB}}**, como defensor(a) dativo(a) do(a)(s) acusado(a)(s) **{{ACUSADOS}}**.\n\nDESABILITE a Defensoria P√∫blica dos autos virtuais.\n\n**CUMPRA-SE A(O) PRESENTE SENTEN√áA/DECIS√ÉO/DESPACHO, SERVINDO COMO CARTA, MANDADO DE CITA√á√ÉO E INTIMA√á√ÉO, CARTA PRECAT√ìRIA, OF√çCIO, NOTIFICA√á√ÉO, OU QUALQUER OUTRO INSTRUMENTO NECESS√ÅRIO PARA FINS DE CUMPRIMENTO DA ORDEM JUDICIAL PELA DCRIM.**\n\nCabo de Santo Agostinho, datado eletronicamente.\nTayn√° Lima Prado\nJu√≠za de Direito";

var M02 = "**DECIS√ÉO**\n\n**I \u2013 RELAT√ìRIO**\n\nTrata-se de a√ß√£o penal submetida ao rito do Tribunal do J√∫ri em que figura como acusado(s) **{{ACUSADOS}}**.\n\n{{CONTEXTO}}\n\n√â o relat√≥rio.\n\n**II \u2013 FUNDAMENTA√á√ÉO JUR√çDICA**\n\nA Constitui√ß√£o Federal assegura aos acusados o contradit√≥rio, a ampla defesa e a assist√™ncia jur√≠dica integral, cabendo ao Estado garantir a efetividade da defesa t√©cnica em todas as fases do processo (art. 5¬∫, incisos LV e LXXIV, da CF).\n\nO C√≥digo de Processo Penal veda o processamento sem defensor e exige manifesta√ß√£o fundamentada da defesa (arts. 261, caput e par√°grafo √∫nico, e 263 do CPP), sendo firme a jurisprud√™ncia do STJ no sentido de que a aus√™ncia de alega√ß√µes finais defensivas, especialmente em processos do Tribunal do J√∫ri, configura nulidade absoluta quando n√£o suprida por atua√ß√£o t√©cnica.\n\nNo caso, **diante da in√©rcia da Defensoria P√∫blica e da inexist√™ncia de defensor p√∫blico designado permanentemente para a unidade**, imp√µe-se a nomea√ß√£o de defensor dativo para assegurar o pleno exerc√≠cio da defesa.\n\n**III - DISPOSITIVO**\n\nAssim, com fundamento na Constitui√ß√£o Federal, no C√≥digo de Processo Penal e na Lei Estadual n¬∫ 17.518/2021:\n\nNomeio o(a) **{{ADVOGADO}}**, OAB/PE n¬∫ **{{OAB}}**, como defensor(a) dativo(a) do(a)(s) acusado(a)(s) **{{ACUSADOS}}**.\n\n**DESABILITE** a Defensoria P√∫blica dos autos virtuais.\n\n**IV - DA CONTINUIDADE DO FEITO**\n\n**DESIGNO/REDESIGNO A AUDI√äNCIA DE CONTINUA√á√ÉO DE INSTRU√á√ÉO E JULGAMENTO** para o dia **{{DATA_AIJ}}**, **A SER REALIZADA NA FORMA H√çBRIDA**, permitindo-se a participa√ß√£o presencial no F√≥rum ou remota por videoconfer√™ncia, mediante plataformas digitais autorizadas pelo Poder Judici√°rio.\n\nProcedam-se √†s intima√ß√µes necess√°rias, advertindo o(a) oficial(a) de justi√ßa de que dever√°, **no ato da intima√ß√£o, indagar ao(√†) intimando(a) se possui acesso a equipamento com internet est√°vel para participa√ß√£o virtual**, hip√≥tese em que dever√° colher e certificar e-mail e telefone para contato.\n\nCaso o(a) intimando(a) **n√£o possua acesso √† internet, dever√° o(a) oficial(a) de justi√ßa certificar tal circunst√¢ncia e intimar as partes, v√≠timas e testemunhas para comparecerem, no dia e hor√°rio designados, √† Vara Regional do J√∫ri do Cabo de Santo Agostinho,** munidas de documento oficial de identifica√ß√£o.\n\nPara o cumprimento dos atos processuais, observe-se:\n\na) As v√≠timas e testemunhas (exceto policiais) **poder√£o ser intimadas tamb√©m por WhatsApp,** certificando-se nos autos;\n\nb) Havendo policiais arrolados, **expe√ßa-se requisi√ß√£o por e-mail, refor√ßando-se a comunica√ß√£o por WhatsApp,** com a orienta√ß√£o de que compare√ßam √† unidade em que est√£o lotados, onde ser√° disponibilizado espa√ßo adequado para a colheita do depoimento por videoconfer√™ncia, ocasi√£o em que ser√° colhido, se for o caso, o compromisso legal previsto no art. 203 do CPP, na forma do art. 16 do Termo de Coopera√ß√£o T√©cnica n¬∫ 02/2020;\n\nc) Conste do mandado de intima√ß√£o advert√™ncia ao(√†) oficial(a) de justi√ßa **para indagar se a v√≠tima e/ou testemunha possui receio de prestar depoimento na presen√ßa do r√©u.**\n\n**√Ä DIRETORIA CRIMINAL/VARA ADERENTE: cumpra-se com urg√™ncia.**\n\n1 \u2013 **Requisitem-se e/ou intimem-se o(s) r√©u(s);**\n\n2 \u2013 **Requisitem-se e/ou intimem-se** as testemunhas arroladas pelas partes, quando residentes nesta comarca (em se tratando de audi√™ncia de continua√ß√£o, especificar apenas as testemunhas a serem ouvidas):\n\n{{TESTEMUNHAS}}\n\n3 \u2013 D√™-se **ci√™ncia ao Minist√©rio P√∫blico de Pernambuco e √† Defensoria P√∫blica/defesas**.\n\nCumpram-se as demais intima√ß√µes necess√°rias √† realiza√ß√£o do ato.\n\nCUMPRA-SE A PRESENTE DECIS√ÉO/DESPACHO/SENTEN√áA, SERVINDO COMO CARTA/MANDADO DE CITA√á√ÉO E INTIMA√á√ÉO, CARTA PRECAT√ìRIA, OF√çCIO, NOTIFICA√á√ÉO OU OUTRO INSTRUMENTO NECESS√ÅRIO AO CUMPRIMENTO DA ORDEM JUDICIAL PELA DCRIM.\n\n**LINK DA AUDI√äNCIA: {{LINK_AUDIENCIA}}**\n\n1 \u2013 Baixar o aplicativo Teams no celular ou computador;\n\n2 \u2013 N√£o se conectar a conta Microsoft, Hotmail ou Outlook;\n\n3 \u2013 Acessar por uma das op√ß√µes:\n\n3.1 \u2013 Clicar no link acima ou escanear o QR Code;\n\n4 \u2013 Inserir o nome e ativar microfone e c√¢mera;\n\n5 \u2013 Clicar em \u201cIngressar agora\u201d.\n\nCabo de Santo Agostinho, datado eletronicamente.\nTayn√° Lima Prado\nJu√≠za de Direito";

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var SENHA_PADRAO='geisonlindo';
function getSenha(){try{return localStorage.getItem('tjpe_senha')||SENHA_PADRAO;}catch(e){return SENHA_PADRAO;}}
function fazerLogin(){
  var v=document.getElementById('login-input').value;
  if(v===getSenha()){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('main-app').style.display='flex';
    try{sessionStorage.setItem('tjpe_auth','1');}catch(e){}
  }else{
    document.getElementById('login-err').style.display='block';
    document.getElementById('login-input').value='';
    document.getElementById('login-input').focus();
  }
}
function alterarSenha(){
  var n=document.getElementById('novaSenha').value,c=document.getElementById('confSenha').value;
  if(!n){toast('DIGITE A NOVA SENHA.','e');return;}
  if(n!==c){toast('AS SENHAS N√ÉO COINCIDEM.','e');return;}
  try{localStorage.setItem('tjpe_senha',n);}catch(e){toast('ERRO AO SALVAR.','e');return;}
  document.getElementById('novaSenha').value='';document.getElementById('confSenha').value='';
  toast('‚úÖ SENHA ALTERADA COM SUCESSO!','s');
}

// ‚îÄ‚îÄ GOOGLE CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var GCAL_CLIENT_ID='543067010522-qk22diekllfleqlf98u3pf54o5mvcpl9.apps.googleusercontent.com';
var GCAL_CALENDAR_ID = 'vararegionaldojuricabodesantoa@gmail.com';
var GCAL_SCOPES='https://www.googleapis.com/auth/calendar.events';
var gcalToken=null;
function abrirCalendario(){window.open('https://calendar.google.com/calendar/u/0/r?authuser='+encodeURIComponent(GCAL_CALENDAR_ID),'_blank');}
function gcalLogin(cb){
  var w=500,h=600,left=(screen.width-w)/2,top=(screen.height-h)/2;
  window._gcalCb=cb;
  window.addEventListener('message',function handler(e){if(e.data&&e.data.type==='gcal_token'){window.removeEventListener('message',handler);gcalToken=e.data.token;if(window._gcalCb)window._gcalCb();}});
  var authUrl='https://accounts.google.com/o/oauth2/v2/auth?client_id='+encodeURIComponent(GCAL_CLIENT_ID)+'&redirect_uri='+encodeURIComponent('https://mercesgeison.github.io/pautajuri/oauth.html')+'&response_type=token&scope='+encodeURIComponent(GCAL_SCOPES)+'&prompt=consent';
  var popup=window.open(authUrl,'gcal_auth','width='+w+',height='+h+',left='+left+',top='+top);
  if(!popup){toast('POPUP BLOQUEADO.','e');return;}
  var timer=setInterval(function(){try{var url=popup.location.href;if(url.indexOf('access_token')>-1){clearInterval(timer);var m=url.match(/access_token=([^&]+)/);if(m){gcalToken=m[1];popup.close();if(cb)cb();}}}catch(e){}if(popup.closed)clearInterval(timer);},200);
}

function limparFormulario(){
  if(!confirm('Deseja limpar todos os campos do formul√°rio?')) return;

  // Preserva estat√≠sticas e prefer√™ncias
  var _ctrl = S.ctrl, _hist = S.hist, _aud = S.aud, _dark = S.dark;

  // Reseta estado principal do formul√°rio
  S={proc:'',acusados:'',advId:'',advNome:'',advOab:'',ctx:'',obs:'',locobs:'nenhum',
     teraij:'NAO',dataij:'',horaIni:'',horaFim:'',reuPreso:false,link:'',
     wAc:[{n:'',e:'',i:''}],wDf:[{n:'',e:'',i:''}],
     obsConn:S.obsConn,minMd:'',minTxt:'',minHtml:'',
     ctrl:_ctrl||{},hist:_hist||[],aud:_aud||{},dark:_dark};

  // Limpa inputs do formul√°rio (p√°gina de cadastro)
  var box=document.getElementById('pg-form')||document;
  box.querySelectorAll('input,select,textarea').forEach(function(el){
    if(el.type==='checkbox'||el.type==='radio'){el.checked=false;}
    else{el.value='';}
  });

  // Re-renderiza testemunhas (mant√©m 1 linha vazia em cada)
  try{renderW('ac');renderW('df');}catch(e){}

  // Limpa minuta e status do calend√°rio
  try{document.getElementById('mpre').textContent='';}catch(e){}
  try{setCalStatus('','');}catch(e){}
  var bc=document.getElementById('btnCal'); if(bc){bc.style.display='none'; bc.textContent='AGENDAR';}

  toast('‚úÖ Formul√°rio limpo.','s');
}

function setCalStatus(msg,tipo){
  var el=document.getElementById('cal-status');
  if(!msg){el.style.display='none';el.textContent='';return;}
  el.textContent=msg;el.className=tipo==='ok'?'ok':'err';el.style.display='block';
  if(tipo==='ok')setTimeout(function(){el.style.display='none';},8000);
}
async function criarEventoCalendar(){
  var btn=document.getElementById('btnCal');
  S.dataij=normalizeDataAIJ(S.dataij);
  if(!S.dataij){toast('PREENCHA A DATA DA AIJ.','e');return;}
  btn.disabled=true;btn.textContent='‚è≥ AGENDANDO...';
  var partes=S.dataij.split('/');if(partes.length!==3){toast('DATA INV√ÅLIDA.','e');btn.disabled=false;resetBtnCal();return;}
  var dataISO=partes[2]+'-'+partes[1]+'-'+partes[0],hi=S.horaij||'08:00';
  var hf=(function(){var p=hi.split(':'),h=parseInt(p[0])+2,m=parseInt(p[1]||0);return(h<10?'0':'')+h+':'+(m<10?'0':'')+m;}());
  var evento={summary:'AIJ ‚Äî Proc. '+S.proc+' ‚Äî '+S.acusados.toUpperCase(),description:'Processo: '+S.proc+'\nAcusado(s): '+S.acusados.toUpperCase()+'\nAdvogado(a): '+S.advNome+' ‚Äî OAB '+S.advOab+(S.link?'\nLink: '+S.link:''),start:{dateTime:dataISO+'T'+hi+':00',timeZone:'America/Recife'},end:{dateTime:dataISO+'T'+hf+':00',timeZone:'America/Recife'},colorId:'11'};
  async function enviar(){
    try{
      // Checagem de conflito (pauta j√° ocupada no mesmo hor√°rio)
      try{
        var timeMin=dataISO+'T'+hi+':00-03:00';
        var timeMax=dataISO+'T'+hf+':00-03:00';
        var urlList='https://www.googleapis.com/calendar/v3/calendars/'+encodeURIComponent(GCAL_CALENDAR_ID)+'/events'
          +'?singleEvents=true&orderBy=startTime'
          +'&timeMin='+encodeURIComponent(timeMin)
          +'&timeMax='+encodeURIComponent(timeMax);
        var rList=await fetch(urlList,{method:'GET',headers:{'Authorization':'Bearer '+gcalToken}});
        if(rList.ok){
          var bdList=await rList.json().catch(function(){return{};});
          var itens=(bdList&&bdList.items)||[];
          if(itens.length>0){
            var okDup=confirm('J√° existe audi√™ncia marcada para essa data e hor√°rio. Voc√™ mesmo assim quer continuar com duas AIJ¬¥S no mesmo hor√°rio?');
            if(!okDup){toast('AGENDAMENTO CANCELADO.','i');btn.disabled=false;resetBtnCal();return;}
            // Prefixo para indicar pauta dupla
            evento.summary='PAUTA DUPLA: Processo '+S.proc+' ‚Äî '+evento.summary;
          }
        }
      }catch(e){ /* se falhar a checagem, segue o fluxo normal */ }

      var r=await fetch('https://www.googleapis.com/calendar/v3/calendars/'+encodeURIComponent(GCAL_CALENDAR_ID)+'/events',{method:'POST',headers:{'Authorization':'Bearer '+gcalToken,'Content-Type':'application/json'},body:JSON.stringify(evento)});
      if(r.ok){toast('‚úÖ AUDI√äNCIA AGENDADA!','s');setCalStatus('‚úÖ EVENTO CRIADO ‚Äî '+S.dataij+(S.horaIni&&S.horaFim?' DAS '+S.horaIni+' √ÄS '+S.horaFim:(S.horaIni?' √ÄS '+S.horaIni:''))+(S.reuPreso?' | R√âU PRESO':''),'ok');alert('Verificar no CALEND√ÅRIO o agendamento');btn.textContent='‚úÖ AGENDADO';btn.style.background='linear-gradient(135deg,#10B981,#047857)';}
      else if(r.status===401){gcalToken=null;toast('SESS√ÉO EXPIRADA.','e');alert('Sua sess√£o do Google expirou. Fa√ßa login novamente e tente agendar.');btn.disabled=false;resetBtnCal();}
      else{var bd=await r.json().catch(function(){return{};});var _msg=((bd.error&&bd.error.message)||('STATUS '+r.status));toast('ERRO: '+_msg,'e');alert('Falha ao agendar no Google Calendar: '+_msg+'\n\nSe persistir, verifique permiss√µes do calend√°rio e tente novamente.');btn.disabled=false;resetBtnCal();}
    }catch(ex){toast('ERRO DE REDE: '+ex.message,'e');alert('Falha de rede ao tentar agendar.\n\nDetalhe: '+ex.message);btn.disabled=false;resetBtnCal();}
  }
  if(gcalToken)await enviar();else gcalLogin(async function(){await enviar();});
}
function resetBtnCal(){
  var btn=document.getElementById('btnCal');btn.style.background='';
  btn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> AGENDAR';
}

// ‚îÄ‚îÄ ESTADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var S={proc:'',acusados:'',advId:'',advNome:'',advOab:'',ctx:'',obs:'',locobs:'nenhum',teraij:'NAO',dataij:'',horaIni:'',horaFim:'',reuPreso:false,link:'',wAc:[{n:'',e:'',i:''}],wDf:[{n:'',e:'',i:''}],obsConn:false,minMd:'',minWord:'',tab:'w',ctrl:{},hist:[],aud:[],dark:true};

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirPje(){window.open('https://sso.cloud.pje.jus.br/auth/realms/pje/protocol/openid-connect/auth?response_type=code&client_id=pje-tjpe-1g-cloud&redirect_uri=https%3A%2F%2Fpje.cloud.tjpe.jus.br%2F1g%2Flogin.seam&state=bb9585f8-0896-467d-9ea9-6c5d1a78c206&login=true&scope=openid','_blank','width='+Math.floor(screen.width/2)+',height='+screen.height+',left='+Math.floor(screen.width/2)+',top=0');}
function toggleTheme(){S.dark=!S.dark;document.body.classList.toggle('light',!S.dark);document.getElementById('themeBtn').style.background=S.dark?'#4F8EF7':'#B8C7E8';document.getElementById('thumbBtn').style.left=S.dark?'17px':'3px';try{localStorage.setItem('tjpe_theme',S.dark?'dark':'light');}catch(e){}}
function goPage(p){['form','minuta','stats','config'].forEach(function(k){document.getElementById('pg-'+k).classList.toggle('active',k===p);document.getElementById('nb-'+k).classList.toggle('on',k===p);});if(p==='stats'){renderStats();renderHist();renderAud();}}
var tT;
function toast(msg,type){var el=document.getElementById('toast');el.textContent=msg;el.className='toast t'+(type||'i');el.style.display='block';clearTimeout(tT);tT=setTimeout(function(){el.style.display='none';},5000);}

/* fetch com timeout (evita travar em ambientes como GitHub Pages ao tentar Obsidian local) */
async function fetchComTimeout(url,opt,ms){
  var ctrl=new AbortController();
  var t=setTimeout(function(){try{ctrl.abort();}catch(e){}}, ms||2500);
  try{
    opt=opt||{};
    opt.signal=ctrl.signal;
    return await fetch(url,opt);
  } finally {
    clearTimeout(t);
  }

function soDigitos(s){return (s||'').replace(/\D+/g,'');}
function maskData(el){
  var d=soDigitos(el.value).slice(0,8);
  var out='';
  if(d.length>=2) out+=d.slice(0,2);
  if(d.length>=3) out+='/'+d.slice(2,4);
  if(d.length>=5) out+='/'+d.slice(4,8);
  el.value=out;
  return out;
}
function maskHora(el){
  var d=soDigitos(el.value).slice(0,4);
  var out='';
  if(d.length>=2) out+=d.slice(0,2);
  if(d.length>=3) out+=':'+d.slice(2,4);
  el.value=out;
  return out;
}

function normalizeDataAIJ(s){
  var d=soDigitos(s).slice(0,8);
  if(d.length===8) return d.slice(0,2)+'/'+d.slice(2,4)+'/'+d.slice(4,8);
  return s||'';
}
function horaValida(h){
  if(!h||h.indexOf(':')<0) return false;
  var p=h.split(':'),hh=parseInt(p[0],10),mm=parseInt(p[1],10);
  if(isNaN(hh)||isNaN(mm)) return false;
  return hh>=0&&hh<=23&&mm>=0&&mm<=59;
}
function cmpHora(a,b){
  // retorna -1/0/1 comparando HH:MM
  var pa=a.split(':'),pb=b.split(':');
  var ta=parseInt(pa[0],10)*60+parseInt(pa[1],10);
  var tb=parseInt(pb[0],10)*60+parseInt(pb[1],10);
  return ta<tb?-1:(ta>tb?1:0);
}
}

function calcProg(){
  var sim=S.teraij==='SIM',total=sim?6:4,done=0;
  if(S.proc)done++;if(S.acusados)done++;if(S.advId)done++;if(S.ctx)done++;
  if(sim){S.dataij=normalizeDataAIJ(S.dataij);if(S.dataij)done++;if(S.link)done++;}
  var pct=Math.min(100,Math.round(done/total*100));
  document.getElementById('pf').style.width=pct+'%';document.getElementById('pct').textContent=pct+'%';
  document.getElementById('btnGerar').disabled=!(S.proc&&S.acusados&&S.advId&&S.ctx&&(!sim||S.dataij));
}
function atualizarBtnCal(){var btn=document.getElementById('btnCal');if(S.teraij==='SIM'&&S.dataij&&S.minMd){btn.style.display='inline-flex';btn.disabled=false;resetBtnCal();}else btn.style.display='none';}
function updateAijDt(){var el=document.getElementById('aij-dt');var dt='';if(S.dataij){if(S.horaIni&&S.horaFim)dt=S.dataij+' DAS '+S.horaIni+' √ÄS '+S.horaFim;else if(S.horaIni)dt=S.dataij+' √ÄS '+S.horaIni;else dt=S.dataij;}if(dt){el.textContent='üìÖ '+dt+(S.reuPreso?'  |  üî¥ R√âU PRESO':'');el.style.display='block';}else el.style.display='none';}
function renderW(b){
  var arr=b==='ac'?S.wAc:S.wDf,c=document.getElementById('w'+b);c.innerHTML='';
  arr.forEach(function(t,i){
    var div=document.createElement('div');div.className='wc';
    function inp(pl,fld){var el=document.createElement('input');el.type='text';el.placeholder=pl;el.value=t[fld]||'';el.addEventListener('input',function(){(b==='ac'?S.wAc:S.wDf)[i][fld]=this.value;});return el;}
    div.appendChild(inp('NOME','n'));div.appendChild(inp('ENDERE√áO','e'));div.appendChild(inp('ID / CPF','i'));
    var btn=document.createElement('button');btn.className='btn bd';btn.style.cssText='padding:4px 10px;font-size:.68rem;margin-top:12px;display:block;margin-left:auto;';btn.textContent='REMOVER';
    btn.onclick=(function(idx){return function(){var a=b==='ac'?S.wAc:S.wDf;if(a.length>1){a.splice(idx,1);renderW(b);}}})(i);
    div.appendChild(btn);c.appendChild(div);
  });
}
function addW(b){(b==='ac'?S.wAc:S.wDf).push({n:'',e:'',i:''});renderW(b);}
function montaT(b){
  var arr=b==='ac'?S.wAc:S.wDf,lbl=b==='ac'?'TESTEMUNHA DE ACUSA√á√ÉO':'TESTEMUNHA DE DEFESA';
  return arr.filter(function(t){return t.n||t.e||t.i;}).map(function(t){var ps=[];if(t.n)ps.push('Nome: '+t.n);if(t.e)ps.push('Endere√ßo: '+t.e);if(t.i)ps.push('ID: '+t.i);return '**'+lbl+':** '+ps.join(' / ');}).join('\n');
}

// ‚îÄ‚îÄ OBSIDIAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function obsBase(){try{return(document.getElementById('cUrl').value||'https://127.0.0.1:27124').replace(/\/$/,'');}catch(e){return'https://127.0.0.1:27124';}}
function obsTok(){try{return document.getElementById('cTok').value||'';}catch(e){return'';}}
function obsH(){var h={};var t=obsTok();if(t)h['Authorization']='Bearer '+t;return h;}
function encP(p){return p.split('/').map(encodeURIComponent).join('/');}
function setObsStatus(online){
  var dot=document.getElementById('dot'),lbl=document.getElementById('obsLabel'),btn=document.getElementById('btnObsStatus');
  if(online){dot.style.background='#10B981';lbl.textContent='ONLINE';btn.style.color='#10B981';btn.style.borderColor='rgba(16,185,129,.3)';btn.style.background='rgba(16,185,129,.08)';}
  else{dot.style.background='#F59E0B';lbl.textContent='OFFLINE';btn.style.color='#F59E0B';btn.style.borderColor='#263552';btn.style.background='#141D35';}
}
async function testarObs(){
  var lbl=document.getElementById('obsLabel');lbl.textContent='...';
  try{var r=await fetchComTimeout(obsBase()+'/',{method:'GET',headers:obsH()},2000);if(r.ok||r.status===401||r.status===403){S.obsConn=true;setObsStatus(true);toast('OBSIDIAN ONLINE ‚úÖ','s');}else throw new Error('STATUS '+r.status);}
  catch(e){S.obsConn=false;setObsStatus(false);toast('FALHA: '+e.message,'e');}
}
async function lerObs(path){
  var b=obsBase(),b2=b.includes('127.0.0.1')?b.replace('127.0.0.1','localhost'):b.replace('localhost','127.0.0.1');
  var urls=[b+'/vault/'+encP(path),b2+'/vault/'+encP(path)];
  for(var i=0;i<urls.length;i++){try{var r=await fetchComTimeout(urls[i],{method:'GET',headers:obsH()},2500);if(r.ok)return{ok:true,txt:await r.text()};}catch(e){}}
  return{ok:false};
}
async function salvarObs(txt,advNome){
  if(!S.obsConn)return{ok:false,msg:'OBSIDIAN OFFLINE'};
  var dt=new Date().toLocaleDateString('pt-BR'),proc=S.proc.replace(/[^\w\s\-]/g,'');
  var nome='VARA REGIONAL DO J√öRI - TJPE/1 - MODELOS DE DECIS√ïES/Decis√µes/Processo '+proc+', Nomea√ß√£o Dativo(a) '+advNome+', '+dt+'.md';
  try{var r=await fetch(obsBase()+'/vault/'+encP(nome),{method:'POST',headers:Object.assign({'Content-Type':'text/plain;charset=utf-8'},obsH()),body:txt});return r.ok?{ok:true,msg:'NOTA CRIADA NO OBSIDIAN.'}:{ok:false,msg:'ERRO STATUS '+r.status};}
  catch(e){return{ok:false,msg:'ERRO: '+e.message};}
}

// ‚îÄ‚îÄ MODELO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function preencherModelo(txt){
  var dt='';if(S.dataij){if(S.horaIni&&S.horaFim)dt=S.dataij+' DAS '+S.horaIni+' √ÄS '+S.horaFim;else if(S.horaIni)dt=S.dataij+' √ÄS '+S.horaIni;else dt=S.dataij;}
  return txt.split('{{ACUSADOS}}').join(S.acusados.toUpperCase())
    .split('{{ADVOGADO}}').join(S.advNome)
    .split('{{OAB}}').join(S.advOab)
    .split('{{CONTEXTO}}').join(S.ctx)
    .split('{{DATA_AIJ}}').join(dt)
    .split('{{LINK_AUDIENCIA}}').join(S.link||'(link n√£o informado)')
    .split('{{TESTEMUNHAS}}').join([montaT('ac'),montaT('df')].filter(Boolean).join('\n')||'(nenhuma testemunha informada)');
}
function inserirObs(m){
  if(!S.obs||S.locobs==='nenhum')return m;
  if(S.locobs==='apos_nomeio'){
    var linhas=m.split('\n'),idxNomeio=-1;
    for(var li=0;li<linhas.length;li++){if(idxNomeio===-1&&/nomeio\s+o\(a\)/i.test(linhas[li]))idxNomeio=li;}
    if(idxNomeio>-1){var ins=idxNomeio+1;while(ins<linhas.length&&linhas[ins].trim()!==''&&!/desabilite/i.test(linhas[ins]))ins++;linhas.splice(ins,0,'',S.obs,'');m=linhas.join('\n').replace(/\n{3,}/g,'\n\n');}
  }else if(S.locobs==='relatorio'){
    var mc=['**II \u2013 FUNDAMENTA√á√ÉO','II \u2013 FUNDAMENTA√á√ÉO','**II - FUNDAMENTA√á√ÉO','II - FUNDAMENTA√á√ÉO'];
    for(var mi=0;mi<mc.length;mi++){if(m.indexOf(mc[mi])>-1){m=m.replace(mc[mi],S.obs+'\n\n'+mc[mi]);break;}}
  }else if(S.locobs==='fundamentacao'){
    var mc2=['**III - DISPOSITIVO','III - DISPOSITIVO','**III \u2013 DISPOSITIVO','III \u2013 DISPOSITIVO'];
    for(var mi2=0;mi2<mc2.length;mi2++){if(m.indexOf(mc2[mi2])>-1){m=m.replace(mc2[mi2],S.obs+'\n\n'+mc2[mi2]);break;}}
  }
  return m;
}

// ‚îÄ‚îÄ GERAR MINUTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function gerarMinuta(){
  var btn=document.getElementById('btnGerar');
  btn.disabled=true;btn.textContent='‚è≥ GERANDO...';
  setCalStatus('','');document.getElementById('btnCal').style.display='none';
  try{
    if(!S.advNome){toast('SELECIONE O ADVOGADO DATIVO.','e');btn.disabled=false;btn.textContent='‚ö° GERAR MINUTA';return;}
    try{localStorage.setItem('tjpe_m01',document.getElementById('cM01').value);localStorage.setItem('tjpe_m02',document.getElementById('cM02').value);localStorage.setItem('tjpe_url',document.getElementById('cUrl').value);localStorage.setItem('tjpe_tok',document.getElementById('cTok').value);}catch(e){}
    var modelPath=S.teraij==='SIM'?document.getElementById('cM02').value:document.getElementById('cM01').value;
    var res=(S.obsConn?await lerObs(modelPath):{ok:false}),m='';
    if(res.ok){
      m=preencherModelo(res.txt);
      toast('‚úÖ MODELO '+(S.teraij==='SIM'?'02':'01')+' CARREGADO DO OBSIDIAN.','s');
    }else{
      m=preencherModelo(S.teraij==='SIM'?M02:M01);
      toast('üìã MODELO '+(S.teraij==='SIM'?'02':'01')+' EMBUTIDO UTILIZADO.','i');
    }
    m=inserirObs(m);
    S.minMd=m;S.minWord=m.replace(/\*\*(.*?)\*\*/g,'$1');
    renderMinuta();atualizarBtnCal();
    var sv=await salvarObs(m,S.advNome);if(sv.ok)toast('‚úÖ '+sv.msg,'s');
    var dth=new Date().toLocaleDateString('pt-BR');
    if(!S.ctrl[S.advId])S.ctrl[S.advId]={nomeacoes:0,ultimaData:'',nome:S.advNome};
    S.ctrl[S.advId].nomeacoes++;S.ctrl[S.advId].ultimaData=dth;
    try{localStorage.setItem('tjpe_ctrl',JSON.stringify(S.ctrl));}catch(e){}
    S.hist.unshift({id:Date.now(),data:dth,advogado:S.advNome,acusados:S.acusados.toUpperCase(),processo:S.proc});
    S.hist=S.hist.slice(0,10);try{localStorage.setItem('tjpe_hist',JSON.stringify(S.hist));}catch(e){}
    if(S.teraij==='SIM'&&S.dataij){var dts2=S.dataij+(S.horaIni&&S.horaFim?' DAS '+S.horaIni+' √ÄS '+S.horaFim:(S.horaIni?' √ÄS '+S.horaIni:''));S.aud.unshift({id:Date.now(),dataAIJ:dts2,link:S.link,processo:S.proc,acusados:S.acusados.toUpperCase(),advogado:S.advNome});S.aud=S.aud.slice(0,200);try{localStorage.setItem('tjpe_aud',JSON.stringify(S.aud));}catch(e){}}
    goPage('minuta');
  }catch(e){toast('ERRO: '+e.message.toUpperCase(),'e');}
  btn.disabled=false;btn.textContent='‚ö° GERAR MINUTA';calcProg();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMinuta(){
  var empty=document.getElementById('m-empty'),content=document.getElementById('m-content');
  if(S.minMd){empty.style.display='none';content.style.display='block';}else{empty.style.display='block';content.style.display='none';return;}
  document.getElementById('mpre').textContent=S.tab==='w'?S.minWord:S.minMd;
}
function setTab(t){S.tab=t;document.getElementById('tw').className='tab'+(t==='w'?' on':'');document.getElementById('tm').className='tab'+(t==='m'?' on':'');renderMinuta();}
function mdParaHtml(txt){txt=txt.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/_(.*?)_/g,'<i>$1</i>');return txt.split(/\n\n+/).map(function(p){return'<p style="margin:0 0 10px 0;">'+p.replace(/\n/g,'<br>')+'</p>';}).join('');}
function copiar(){
  var div=document.createElement('div');div.style.cssText='position:fixed;top:0;left:0;opacity:0;pointer-events:none;';div.innerHTML=mdParaHtml(S.minMd);document.body.appendChild(div);
  var range=document.createRange();range.selectNodeContents(div);var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);
  var ok=false;try{ok=document.execCommand('copy');}catch(e){}
  sel.removeAllRanges();document.body.removeChild(div);
  if(ok)toast('COPIADO COM FORMATA√á√ÉO! ‚úÖ','s');else navigator.clipboard.writeText(S.minWord).then(function(){toast('COPIADO (SEM FORMATA√á√ÉO)! ‚ö†Ô∏è','i');});
}
function zerarCtrl(){S.ctrl={};S.hist=[];try{localStorage.setItem('tjpe_ctrl','{}');localStorage.setItem('tjpe_hist','[]');}catch(e){}renderStats();renderHist();toast('CONTAGENS ZERADAS.','s');}
function zerarAud(){S.aud=[];try{localStorage.setItem('tjpe_aud','[]');}catch(e){}renderAud();toast('AUDI√äNCIAS ZERADAS.','s');}
function renderStats(){var el=document.getElementById('stats-list');el.innerHTML='';var arr=Object.values(S.ctrl).sort(function(a,b){return b.nomeacoes-a.nomeacoes;});if(!arr.length){el.innerHTML='<div class="empty">NENHUMA NOMEA√á√ÉO REGISTRADA.</div>';return;}arr.forEach(function(c){var d=document.createElement('div');d.className='sr';d.innerHTML='<div style="flex:1;min-width:0;"><div class="snm">'+c.nome+'</div></div><div style="text-align:right;flex-shrink:0;margin-left:8px;"><div class="sn">'+c.nomeacoes+'</div><div class="ss">'+(c.ultimaData||'‚Äî')+'</div></div>';el.appendChild(d);});}
function renderHist(){var hc=document.getElementById('hist-card'),el=document.getElementById('hist-list');if(!S.hist.length){hc.style.display='none';return;}hc.style.display='block';el.innerHTML='';S.hist.slice(0,5).forEach(function(h){var d=document.createElement('div');d.className='hi';d.innerHTML='<div class="hd">'+h.data+'</div><div class="ha">'+h.advogado+'</div><div class="hs">'+h.acusados+'</div><div class="hs" style="color:#4A6080">PROC. '+h.processo+'</div>';el.appendChild(d);});}
function renderAud(){var el=document.getElementById('aud-list');el.innerHTML='';if(!S.aud.length){el.innerHTML='<div class="empty">NENHUMA AUDI√äNCIA REGISTRADA.</div>';return;}S.aud.slice(0,30).forEach(function(a){var d=document.createElement('div');d.className='ci';d.innerHTML='<div class="cd">üìÖ '+a.dataAIJ+'</div><div class="cs">PROCESSO: '+a.processo+'</div><div class="cs">ACUSADO(S): '+a.acusados+'</div><div class="cs">ADVOGADO(A): '+a.advogado+'</div>'+(a.link?'<div class="cs">üîó '+a.link+'</div>':'');el.appendChild(d);});}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded',function(){
  try{if(sessionStorage.getItem('tjpe_auth')==='1'){document.getElementById('login-screen').style.display='none';document.getElementById('main-app').style.display='flex';}}catch(e){}
  try{
    var c=localStorage.getItem('tjpe_ctrl');if(c)S.ctrl=JSON.parse(c);
    var h=localStorage.getItem('tjpe_hist');if(h)S.hist=JSON.parse(h);
    var a=localStorage.getItem('tjpe_aud');if(a)S.aud=JSON.parse(a);
    var m1=localStorage.getItem('tjpe_m01');if(m1)document.getElementById('cM01').value=m1;
    var m2=localStorage.getItem('tjpe_m02');if(m2)document.getElementById('cM02').value=m2;
    var cu=localStorage.getItem('tjpe_url');if(cu)document.getElementById('cUrl').value=cu;
    var ct=localStorage.getItem('tjpe_tok');if(ct)document.getElementById('cTok').value=ct;
    var th=localStorage.getItem('tjpe_theme');if(th==='light'){S.dark=true;toggleTheme();}
  }catch(e){}
  document.getElementById('f1').addEventListener('input',function(){S.proc=this.value;calcProg();});
  document.getElementById('f2').addEventListener('input',function(){S.acusados=this.value;calcProg();});
  document.getElementById('f4').addEventListener('input',function(){S.ctx=this.value;calcProg();});
  document.getElementById('fdata').addEventListener('input',function(){S.dataij=maskData(this);updateAijDt();calcProg();});
  document.getElementById('fhoraIni').addEventListener('input',function(){S.horaIni=maskHora(this);updateAijDt();});
  document.getElementById('fhoraFim').addEventListener('input',function(){S.horaFim=maskHora(this);updateAijDt();});
  document.getElementById('fpreso').addEventListener('change',function(){S.reuPreso=!!this.checked;updateAijDt();});
  document.getElementById('flink').addEventListener('input',function(){S.link=this.value;calcProg();});
  document.getElementById('fobs').addEventListener('input',function(){S.obs=this.value;});
  document.getElementById('flocobs').addEventListener('change',function(){S.locobs=this.value;var ta=document.getElementById('fobs');ta.disabled=this.value==='nenhum';ta.style.opacity=this.value==='nenhum'?'.4':'1';});
  document.getElementById('faij').addEventListener('change',function(){S.teraij=this.value;document.getElementById('aij-bloco').style.display=this.value==='SIM'?'block':'none';calcProg();});
  document.getElementById('f3').addEventListener('change',function(){
    var opt=this.options[this.selectedIndex];S.advId=this.value||'';S.advNome=opt?(opt.getAttribute('data-nome')||''):'';S.advOab=opt?(opt.getAttribute('data-oab')||''):'';
    var box=document.getElementById('advbox');if(S.advNome){box.textContent='‚úÖ '+S.advNome+' ¬∑ OAB '+S.advOab;box.style.display='block';}else box.style.display='none';
    calcProg();
  });
  renderW('ac');renderW('df');renderStats();renderHist();renderAud();calcProg();
});
</script>
</body>
</html>
